name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    # Lintã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ãƒ†ã‚¹ãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    checks:
        name: Code Quality Checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Get dependencies
              run: flutter pub get

            - name: Lint check
              run: flutter analyze

            - name: Format check
              run: dart format --set-exit-if-changed .

            - name: Run tests
              run: flutter test

    # macOS ãƒ“ãƒ«ãƒ‰
    build-macos:
        name: Build macOS
        runs-on: macos-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Get dependencies
              run: flutter pub get

            - name: Build macOS
              run: flutter build macos --release

    # Windows ãƒ“ãƒ«ãƒ‰
    build-windows:
        name: Build Windows
        runs-on: windows-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Get dependencies
              run: flutter pub get

            - name: Build Windows
              run: flutter build windows --release

    # Linux ãƒ“ãƒ«ãƒ‰
    build-linux:
        name: Build Linux
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev

            - name: Get dependencies
              run: flutter pub get

            - name: Build Linux
              run: flutter build linux --release

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ã€å¤±æ•—ã—ã¦ã‚‚CIã¯é€šã‚‹ï¼‰
    security:
        name: Security Checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Get dependencies
              run: flutter pub get

            - name: Check outdated packages
              run: dart pub outdated || true
              continue-on-error: true

            - name: Security check (vulnerabilities and package verification)
              run: |
                  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã®ã¿å®Ÿè¡Œ
                  # pre-commitã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯éƒ¨åˆ†ã‚’å®Ÿè¡Œ
                  echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
                  dart pub deps --json > /dev/null 2>&1 || echo "ä¾å­˜é–¢ä¿‚ã®å–å¾—ã«å¤±æ•—"
                  dart run scripts/pre_commit.dart 2>&1 | grep -A 100 "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯" || echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
              continue-on-error: true
              timeout-minutes: 10
