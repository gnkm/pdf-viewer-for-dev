name: Release

on:
    push:
        tags:
            - "v*" # v1.0.0 のようなタグでトリガー

jobs:
    # macOS リリースビルド
    build-macos:
        name: Build macOS Release
        runs-on: macos-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Get dependencies
              run: flutter pub get

            - name: Build macOS
              run: flutter build macos --release

            - name: Create DMG (optional)
              run: |
                  # DMG作成は必要に応じて実装
                  # 現時点では.appバンドルをzipで圧縮
                  cd build/macos/Build/Products/Release
                  zip -r pdf_viewer_for_dev-macos.zip pdf_viewer_for_dev.app

            - name: Upload macOS artifact
              uses: actions/upload-artifact@v4
              with:
                  name: macos-release
                  path: build/macos/Build/Products/Release/pdf_viewer_for_dev-macos.zip
                  if-no-files-found: error

    # Windows リリースビルド
    build-windows:
        name: Build Windows Release
        runs-on: windows-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Get dependencies
              run: flutter pub get

            - name: Build Windows
              run: flutter build windows --release

            - name: Create ZIP archive
              shell: powershell
              run: |
                  $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
                  Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath pdf_viewer_for_dev-windows-$version.zip -Force

            - name: Upload Windows artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-release
                  path: pdf_viewer_for_dev-windows-*.zip
                  if-no-files-found: error

    # Linux リリースビルド
    build-linux:
        name: Build Linux Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: "stable"

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev

            - name: Get dependencies
              run: flutter pub get

            - name: Build Linux
              run: flutter build linux --release

            - name: Create tarball
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  cd build/linux/x64/release/bundle
                  tar -czf pdf_viewer_for_dev-linux-$VERSION.tar.gz *

            - name: Upload Linux artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-release
                  path: build/linux/x64/release/bundle/pdf_viewer_for_dev-linux-*.tar.gz
                  if-no-files-found: error

    # リリース作成とアップロード
    create-release:
        name: Create Release
        needs: [build-macos, build-windows, build-linux]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download macOS artifact
              uses: actions/download-artifact@v4
              with:
                  name: macos-release
                  path: ./artifacts/macos

            - name: Download Windows artifact
              uses: actions/download-artifact@v4
              with:
                  name: windows-release
                  path: ./artifacts/windows

            - name: Download Linux artifact
              uses: actions/download-artifact@v4
              with:
                  name: linux-release
                  path: ./artifacts/linux

            - name: Extract version from tag
              id: get_version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ steps.get_version.outputs.tag }}
                  name: Release ${{ steps.get_version.outputs.version }}
                  body: |
                      ## PDF Viewer for Developers v${{ steps.get_version.outputs.version }}

                      ### ダウンロード

                      - **macOS**: [pdf_viewer_for_dev-macos.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/pdf_viewer_for_dev-macos.zip)
                      - **Windows**: [pdf_viewer_for_dev-windows-${{ steps.get_version.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/pdf_viewer_for_dev-windows-${{ steps.get_version.outputs.version }}.zip)
                      - **Linux**: [pdf_viewer_for_dev-linux-${{ steps.get_version.outputs.version }}.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/pdf_viewer_for_dev-linux-${{ steps.get_version.outputs.version }}.tar.gz)

                      ### インストール方法

                      - **macOS**: ZIPを展開し、`pdf_viewer_for_dev.app`をアプリケーションフォルダに移動
                      - **Windows**: ZIPを展開し、`pdf_viewer_for_dev.exe`を実行
                      - **Linux**: tar.gzを展開し、`pdf_viewer_for_dev`を実行
                  files: |
                      artifacts/macos/*
                      artifacts/windows/*
                      artifacts/linux/*
                  draft: false
                  prerelease: false

